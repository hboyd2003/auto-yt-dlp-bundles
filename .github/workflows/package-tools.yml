name: Bundle yt-dlp + FFmpeg + Deno

on:
  workflow_dispatch:
    inputs:
      triggered_cause:
        description: 'Trigger cause (e.g., FFmpeg 8.0 -> 8.1)'
        required: false
        default: 'manual'
        type: string
      versions:
        description: 'JSON string with version info from version check'
        required: true
        type: string

jobs:
  release_info:
    runs-on: ubuntu-latest
    outputs:
      yt_dlp_release_url: ${{ steps.yt_dlp_release.outputs.release_url }}
      yt_dlp_release_tag: ${{ steps.yt_dlp_release.outputs.release_tag }}
      ffmpeg_release_url: ${{ steps.ffmpeg_release.outputs.release_url }}
      ffmpeg_release_tag: ${{ steps.ffmpeg_release.outputs.release_tag }}
      deno_release_url: ${{ steps.deno_release.outputs.release_url }}
      deno_release_tag: ${{ steps.deno_release.outputs.release_tag }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Display trigger information
        run: |
          echo "Reported trigger: ${{ github.event.inputs.triggered_cause }}"
          if [ -n "${{ github.event.inputs.versions }}" ]; then
            echo "Version info provided:"
            echo '${{ github.event.inputs.versions }}' | jq .
          fi

      - name: Get latest yt-dlp release info
        id: yt_dlp_release
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest)
          RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.html_url')
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo $RELEASE_TAG
          echo $RELEASE_URL

      - name: Get latest FFmpeg release info
        id: ffmpeg_release
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/BtbN/FFmpeg-Builds/releases/latest)
          ACTUAL_RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.name' | sed -e 's/Latest Auto-Build/autobuild/; s/(//g; s/)//g; s/[ :]/-/g')
          RELEASE_URL="https://github.com/BtbN/FFmpeg-Builds/releases/tag/$ACTUAL_RELEASE_TAG"
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release_tag=$ACTUAL_RELEASE_TAG" >> $GITHUB_OUTPUT
          echo $RELEASE_TAG
          echo $RELEASE_URL

      - name: Get latest Deno release info
        id: deno_release
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/denoland/deno/releases/latest)
          RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.html_url')
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo $RELEASE_TAG
          echo $RELEASE_URL

  package:
    runs-on: ubuntu-latest
    needs: release_info
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            yt_dlp_asset: yt-dlp_linux
            ffmpeg_asset: -linux64-gpl-8.0.tar.xz
            deno_asset: deno-x86_64-unknown-linux-gnu.zip
            output_name: bundle-linux-x64.tar.xz
            
          - os: linux
            arch: arm64
            yt_dlp_asset: yt-dlp_linux_aarch64
            ffmpeg_asset: -linuxarm64-gpl-8.0.tar.xz
            deno_asset: deno-aarch64-unknown-linux-gnu.zip
            output_name: bundle-linux-arm64.tar.xz
            
          - os: windows
            arch: x64
            yt_dlp_asset: yt-dlp.exe
            ffmpeg_asset: -win64-gpl-8.0.zip
            deno_asset: deno-x86_64-pc-windows-msvc.zip
            output_name: bundle-windows-x64.tar.xz

    steps:
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq tar xz-utils unzip bc

      - name: Create bundle directory
        run: mkdir -p bundle

      - name: Download & extract yt-dlp
        id: yt_dlp
        run: |
          cd bundle
          RELEASE_INFO=$(curl -s https://api.github.com/repos/yt-dlp/yt-dlp/releases/tags/${{ needs.release_info.outputs.yt_dlp_release_tag }})

          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r ".assets[] | select(.name == \"${{ matrix.yt_dlp_asset }}\") | .browser_download_url")
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          
          curl -L -o "${{ matrix.yt_dlp_asset }}" "$DOWNLOAD_URL"

          if [[ "${{ matrix.os }}" != "windows" ]]; then
            chmod +x "${{ matrix.yt_dlp_asset }}"
            mv "${{ matrix.yt_dlp_asset }}" yt-dlp
          fi

      - name: Download & extract FFmpeg
        id: ffmpeg
        run: |
          cd bundle
          RELEASE_INFO=$(curl -s https://api.github.com/repos/BtbN/FFmpeg-Builds/releases/tags/${{ needs.release_info.outputs.ffmpeg_release_tag }})
          
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r ".assets[] | select(.name | contains(\"${{ matrix.ffmpeg_asset }}\")) | .browser_download_url")
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          
          curl -L -o ffmpeg_archive "$DOWNLOAD_URL"

          # Extract based on file type
          if [[ "${{ matrix.ffmpeg_asset }}" == *.tar.xz ]]; then
            tar -xf ffmpeg_archive --strip-components=1
          elif [[ "${{ matrix.ffmpeg_asset }}" == *.zip ]]; then
            unzip -q ffmpeg_archive
            # Move files from extracted folder to current directory
            mv ffmpeg-*/bin/* . 2>/dev/null || mv ffmpeg-*/* . 2>/dev/null || true
            rm -rf ffmpeg-*/
          fi
          
          # Clean up archive
          rm -f ffmpeg_archive
          
          # Delete everything except FFmpeg binary
          find . -type f ! -name "ffmpeg*" -delete 2>/dev/null || true
          find . -type d -empty -delete 2>/dev/null || true
          
          if [[ "${{ matrix.os }}" != "windows" ]]; then
            chmod +x ffmpeg 2>/dev/null || true
          fi

      - name: Download & extract Deno
        id: deno
        run: |
          cd bundle
          RELEASE_INFO=$(curl -s https://api.github.com/repos/denoland/deno/releases/tags/${{ needs.release_info.outputs.deno_release_tag }})
          echo "version=$(echo $RELEASE_INFO | jq -r '.tag_name')" >> $GITHUB_OUTPUT
          
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r ".assets[] | select(.name == \"${{ matrix.deno_asset }}\") | .browser_download_url")
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          
          curl -L -o deno_archive.zip "$DOWNLOAD_URL"
          
          unzip -q deno_archive.zip
          rm -f deno_archive.zip

          if [[ "${{ matrix.os }}" != "windows" ]]; then
            chmod +x deno
          fi
          
      - name: Create bundle info file
        run: |
          cd bundle
          FFMPEG_VERSION=$(echo '${{ github.event.inputs.versions }}' | jq -r '.ffmpeg')
          cat > info.json << EOF
          {
            "created": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
            "platform": "${{ matrix.os }}-${{ matrix.arch }}",
            "bundled": {
              "yt_dlp": {
                "download_url": "${{ steps.yt_dlp.outputs.download_url }}",
                "version": "${{ needs.release_info.outputs.yt_dlp_release_tag }}"
              },
              "ffmpeg": {
                "download_url": "${{ steps.ffmpeg.outputs.download_url }}",
                "version": "${{ steps.ffmpeg.outputs.tag }}",
                "build": "${{ needs.release_info.outputs.ffmpeg_release_tag }}"
              },
              "deno": {
                "download_url": "${{ steps.deno.outputs.download_url }}",
                "version": "${{ needs.release_info.outputs.deno_release_tag }}"
              }
            }
          }
          EOF

      - name: Build archive
        run: |
          XZ_OPT=-9 tar -cJf "${{ matrix.output_name }}" bundle/*
          
          # Print archive size
          ls -lh "${{ matrix.output_name }}"

      - name: Generate SHA256 checksum
        run: |
          sha256sum "${{ matrix.output_name }}" > "${{ matrix.output_name }}.sha256"
          cat "${{ matrix.output_name }}.sha256"
      
      - name: Save version info for release notes
        if: matrix.os == 'linux' && matrix.arch == 'x64'  # Only save once
        run: |
          cat > versions.json << EOF
          {
            "yt_dlp": "${{ steps.yt_dlp.outputs.version }}",
            "ffmpeg": "${{ steps.ffmpeg.outputs.version }}",
            "deno": "${{ steps.deno.outputs.version }}"
          }
          EOF
          
          # Also save as a separate artifact for the release
          cp versions.json release-versions.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: |
            ${{ matrix.output_name }}
            ${{ matrix.output_name }}.sha256
          retention-days: 90

  create-release:
    needs:
      - package
      - release_info
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: ls -la artifacts/*/

      - name: Get current date
        id: date
        run: echo "date=$(date -u '+%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create release info
        id: release_info
        run: |
          FFMPEG_VERSION=$(echo '${{ github.event.inputs.versions }}' | jq -r '.ffmpeg')
          echo "ffmpeg_version=$FFMPEG_VERSION" >> $GITHUB_OUTPUT
          cat > release.json << EOF
          {
            "created": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
            "bundled": {
              "yt_dlp": {
                "release_url": "${{ needs.release_info.outputs.yt_dlp_release_url }}",
                "version": "${{ needs.release_info.outputs.yt_dlp_release_tag }}"
              },
              "ffmpeg": {
                "release_url": "${{ needs.release_info.outputs.ffmpeg_release_url }}",
                "version": "$FFMPEG_VERSION",
                "build": "${{ needs.release_info.outputs.ffmpeg_release_tag }}"
              },
              "deno": {
                "release_url": "${{ needs.release_info.outputs.deno_release_url }}",
                "version": "${{ needs.release_info.outputs.deno_release_tag }}"
              }
            }
          }
          EOF

      - name: Create Release
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.date }}
          name: ${{ steps.date.outputs.date }}
          body: |
            # Automated yt-dlp Bundle Release
            This release contains bundled executables of yt-dlp, FFmpeg, and Deno.

            Release cause: ${{ github.event.inputs.triggered_cause }}
            
            ## Release source:
            - FFmpeg: ${{ needs.release_info.outputs.ffmpeg_release_url }}
            - yt-dlp: ${{ needs.release_info.outputs.yt_dlp_release_url }}
            - Deno: ${{ needs.release_info.outputs.deno_release_url }}

            ## Bundled Version
            - **yt-dlp**: ${{ needs.release_info.outputs.yt_dlp_release_tag }}
            - **FFmpeg**: ${{ steps.release_info.outputs.ffmpeg_version }}
            - **Deno**: ${{ needs.release_info.outputs.deno_release_tag }}
            
            ## Available Platforms
            - Linux x64 (AMD64): bundle-linux-x64.tar.xz
            - Linux ARM64 (AArch64): bundle-linux-arm64.tar.xz  
            - Windows x64: bundle-windows-x64.tar.xz
            
            ## Excluded Platforms
            - Windows ARM64 (no Deno support)
            - macOS x64 (no FFmpeg builds from BtbN)
            - macOS ARM64 (no FFmpeg builds from BtbN)

            ## Checksums
            SHA256 checksums are provided for each archive.
          files: |
            artifacts/**/*.tar.xz
            artifacts/**/*.sha256
            release.json
          draft: false
          prerelease: false
